---
title: "Trying to create an AWS account the right way"
publishedAt: "2024-01-22"
description: "Ramblings about my attemepts to create an AWS dev enviornment using AWS organisations and org formation"
tags: ["AWS", "Cloud", "Cloud Resume Challenge", "OrgFormation"]
articleType: "article"
og: "https://ucarecdn.com/8812c8f2-7ef6-43f0-b4a7-6dbce6c0a493/creatinganawsaccounttherightway.png"
status: "published"
series:
  order: 2
  title: "Learning AWS with the Cloud Resume Challenge"
---

This is the second article in my series "Learning AWS with the Cloud Resume Challenge." You can check out the previous post in this series [here](https://www.kxlaa.com/articles/jumping-into-the-world-of-aws).

## Creating an AWS account

What is the best way to create a new AWS account ? From the info in the [Cloud Resume Challenge Guide book](https://cloudresumechallenge.dev/book/), there are two options: the **original way** or the **professional way**.

The original way follows the steps in the [AWS documentation on account management](https://docs.aws.amazon.com/accounts/latest/reference/welcome-first-time-user.html):

- Create your AWS account
- Activate MFA for your root user
- Create an administrator user

The professional way is more complicated. It requires using an AWS service called AWS Organisations to manage accounts in groups called Organisation Units.

I already had an AWS account that I set up in the original way. This time I decided to try something different and set up my accounts using AWS Organisations.

The Cloud Resume Challenge Guide book recommends using an open-source Command Line Interface (CLI) called [`org-formation`](https://github.com/org-formation/org-formation-cli) to create and manage AWS organisations.

I followed a [helpful guide](https://bahr.dev/2022/02/07/org-formation/) on how to use `org-formation` by Bahr. His guide is excellent, but it was written in 2020. Since then, the AWS console has changed slightly, so I had to make extra adjustments at certain steps.

But, In general, these are the steps I took to set up my AWS account with `org-formation`:

<Steps stepCount={5}>
  <StepsItem no={1} heading="Create an AWS management account">
    I followed the [getting started docs on AWS](https://docs.aws.amazon.com/accounts/latest/reference/welcome-first-time-user.html) for this and created my account. This account is the root account with a lot of power, and it serves as the main management account for all the organisations.
  </StepsItem>

  <StepsItem no={2} heading="Install the OrgFormation CLI">
    I installed the CLI by running:

    ```bash
    npm install -g aws-organization-formation
    ```

    In the previous step, I created an [IAM user with administrative access](https://docs.aws.amazon.com/singlesignon/latest/userguide/quick-start-default-idc.html). I used the aws CLI to set the credentials of this administrative user. I also set the default region and output in the `~/.aws` directory using the `aws configure` command.

  </StepsItem>

    <StepsItem no={3} heading="Set up CI with CodeCommit and CodePipeline">
    The next step is to set up AWS Organisations using the `org-formation CLI`. We can do this by running:

    ```bash
    org-formation init-organization --region eu-west-2
    ```

    This command creates a [CodeCommit](https://aws.amazon.com/codecommit/) git repository, and a [CodePipeline](https://aws.amazon.com/codepipeline/) for continuous integration. In the CodeCommit repository, `org-formation` has generated some [CloudFormation templates](https://aws.amazon.com/cloudformation/).

    These templates represent the code-based setup of all my organisations, referred to as Infrastructure as Code (IaC). CloudFormation is an AWS service designed for Infrastructure as Code.

    Whenever I update the templates in the CodeCommit repository, the CodePipeline action automatically runs and updates the affected organisations.

  </StepsItem>

  <StepsItem no={4} heading="Add Your Accounts and  Organisational Units">

     To set up our organisational units and accounts, we need to make some edits to the CloudFormation templates generated by the `org-formation` CLI.

     To do this we need to first clone the CodeCommit git repository locally. We cant clone the CodeCommit repo without the right credentials, to get these credentials:
     - First, [create a new IAM user](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html) with the managed policy called [AWSCodeCommitPowerUser](https://docs.aws.amazon.com/codecommit/latest/userguide/security-iam-awsmanpol.html).
     - Next, go to the Security Credentials tab of the IAM user you created. Scroll down until you find the section titled **HTTPS Git credentials for AWS CodeCommit**. Generate the credentials and download them as a CSV.

     Now that we have the credentials, we can clone the CodeCommit repository. To find the git URL we need, search for the CodeCommit service using the search bar.

     If step 2 was successful, you should see a repository named `organization-formation` in the table. Copy the HTTPS link and use `git clone` in your command line interface.

     When prompted for the username and password, use the credentials we generated earlier, and you'll be all set.

     The rest of the Bahrs article provides a detailed explanation of setting up organizational units and accounts. My setup is very similar.

    I have a `ProductionOU` and a `DevelopmentOU`. Each organizational unit contains accounts for development and production.

</StepsItem>

  <StepsItem no={5} heading="Create an AWS management account">
  For this step, the rest of Bahr's article is really solid. But, I did encounter a strange error in the CodePipeline CI when I tried to register a custom type for AWS SSO:

  <Callout intent="danger" className='font-mono'>
  Task Sso Administrator execute failed. reason: unable to parse expression on attribute parameter master AccountId. Is there an error in the expression? \{"Ref":"MasterAccount"}
  </Callout>

For some unknown reason, the `"Ref":"MasterAccount`" was not resolving to the `masterAccountId`. I had to manually hardcode this `masterAccountId` in the `SsoAdministrator` resource to make it work:

```yaml
SsoAdministrator:
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref adminGroup
    permissionSetName: "Administrator"
    managedPolicies: ["arn:aws:iam::aws:policy/AdministratorAccess"]
    sessionDuration: "PT1H"
    masterAccountId: "<hardcoded masterAccountId>"
```

You can find the `masterAccountId` on the AWS Organizations page. It is the number located next to the email address of the management account.

After that, everything worked as expected. I now have two units for development and production, each with its account. I can easily access both of these using the SSO portal. Nice!

  </StepsItem>
</Steps>

## Concluding thoughts

Now, I didn't have to go through all this hassle to set up my AWS account. I could have simply used my previous account and been more strict with IAM roles and permissions for each IAM user I created.

But, this experience and tinkering around with `org-formation` introduced me to two AWS services I had never heard of before - CodeCommit and CodePipeline.

I even had the opportunity to edit CloudFormation templates, a service widely used in production by many companies.

One thing I would like to mention is that the account management strategy and infrastructure side of IAM and AWS is not my jam. But, I still find it interesting.

Managing AWS accounts for entire engineering organisations can be complex, which makes me appreciate the AWS credentials that I have at my current workplace.

Now that I have an account, the next step is to start building. In the next part of the series, I will build and deploy the front end of the cloud resume using AWS services.

Till next time.
