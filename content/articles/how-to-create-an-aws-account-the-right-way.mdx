---
title: "Trying to Create an AWS account the right way"
publishedAt: "2024-01-22"
description: "Ramblings about my attemepts to create an AWS dev enviornment using AWS organisations and org formation"
tags: ["AWS", "Cloud", "Cloud Resume Challenge", "OrgFormation"]
og: "https://ucarecdn.com/ef3a88c3-277a-4bdd-bd7b-26095f5adf73/jumpingintothescaryworldofaws.png"
status: "published"
series:
  order: 2
  title: "Learning AWS with the Cloud Resume Challenge"
---

This is the second article in my series Learning AWS with the cloud resume challenge. You can checkout the previous post [here](https://www.kxlaa.com/articles/jumping-into-the-world-of-aws).

What is the best way to create a new AWS account and a personal development environment? From the info in the Cloud Resume Challenge Guide book, there are two options: the original way or the professional way.

The original way essentially follows the steps in the [AWS documentation on account management](https://docs.aws.amazon.com/accounts/latest/reference/welcome-first-time-user.html):

- Create your AWS account
- Activate MFA for your root user
- Create an administrator user

The professional way on the other hand is more complicated. It requires using an AWS service called AWS Organisationâ€™s to manage accounts in units called Organisation Units.

I already had an AWS account and i created that account using the original way, by following the instructions in the AWS documentation. This time I decided to try something different and create a new account the professional way.

The Cloud Resume handbook recommends using an open-source Command Line Interface (CLI) called `org-formation` to create and manage AWS organisations. This CLI helps us manage our Organisational Units using infrastructure as code.

I followed a very [great tutorial](https://bahr.dev/2022/02/07/org-formation/) on how to do this by Bahr. However, Bahr's article was written in 2020, so it is a bit outdated. I encountered some issues because the AWS console had changed slightly. As a result, some steps required additional tinkering.

But broadly speaking, these are the steps i took to set up my AWS account with `org-formation`:

<Steps stepCount={5}>
  <StepsItem no={1} heading="Create an AWS management account">
    This part is quite straightforward and I followed the [getting started docs on AWS](https://docs.aws.amazon.com/accounts/latest/reference/welcome-first-time-user.html) for this. This account is the root account with a lot of power - it will serve as the master management account for all the organisations.
  </StepsItem>

  <StepsItem no={2} heading="Install the OrgFormation CLI">
    I installed the CLI by running `npm install -g aws-organization-formation`.

    In the previous step, I created an [IAM user with administrative access](https://docs.aws.amazon.com/singlesignon/latest/userguide/quick-start-default-idc.html). I used the `aws` CLI to set the credentials of this administrative user, as well as the default region and output in the `~/.aws` directory, using the `aws configure` command.

  </StepsItem>

    <StepsItem no={3} heading="Set up CI with CodeCommit and CodePipeline">
    The next step is to set up AWS Organisations using the org-formation CLI. We can do this by running: `org-formation init-pipeline --region eu-west-2`. This command  created a CodeCommit repository (AWS version of GitHub) and a CodePipeline (CI) that would update my organisations with every commit!


    I haven't looked too deeply into how org-formation works, but I know the CLI generates CloudFormation templates, which are then pushed to the CodeCommit repository. These templates represent my organization's setup in code, commonly referred to as Infrastructure as Code (IaC).

    CloudFormation is an AWS service specifically designed for Infrastructure as Code. I am curious if it is possible to set up this infrastructure without relying on org-formation. Perhaps that could be a challenge for another day.

  </StepsItem>

      <StepsItem no={4} heading="Add Your Accounts and  Organisational Units">

      The `org-formation` CLI generates templates that can use to create our organisational units and accounts. However, to actually set them up, we need to edit some of the files in the CodeCommit repository. I tried following the steps in [bahrs](https://bahr.dev/2022/02/07/org-formation/) article but encountered several issues.

      Here are the steps I took to get my accounts and OUs set up:

      First, [create a new IAM user](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html) with the managed policy called [AWSCodeCommitPowerUser](https://docs.aws.amazon.com/codecommit/latest/userguide/security-iam-awsmanpol.html).

      Next, navigate to the Security Credentials tab of the user you just created. Scroll down until you find the section titled "HTTPS Git credentials for AWS CodeCommit". This is where we can generate the username and password credentials required to clone the CodeCommit repository. It will prompt you to download the credentials as a CSV.

      Now that we have the credentials, we can clone the CodeCommit repository. To find the git URL we need, search for the CodeCommit service using the search bar. If step 2 was successful, you should see a repository named "organization-formation" in the table. Copy the HTTPS link and use `git clone` in your command line interface. When prompted for the username and password, use the credentials we generated earlier, and you'll be all set.

      The rest of the bahrs article provides a detailed explanation of how to set up organizational units and accounts. My setup is very similar, with a ProductionOU and a DevelopmentOU, each containing accounts for development and production.

</StepsItem>

  <StepsItem no={5} heading="Create an AWS management account">
For this step, the rest of [bahrs](https://bahr.dev/2022/02/07/org-formation/) article is really solid. However, I did encounter a strange error in the CodePipeline CI when I tried to register a custom type for **AWS SSO:**

For some weird reason, the "Ref":"MasterAccount" was not resolving to the masterAccountId. I had to manually hardcode this masterAccountId in the SsoAdministrator resource for it to work:

```yaml
SsoAdministrator:
  Type: update-stacks
  Template: ./aws-sso.yml
  StackName: !Sub "${resourcePrefix}-${appName}-admin"
  StackDescription: "Full permission role used by Admin group within whole organization"
  TerminationProtection: false
  DefaultOrganizationBindingRegion: !Ref primaryRegion
  DefaultOrganizationBinding:
    IncludeMasterAccount: true
  OrganizationBindings:
    TargetBinding:
      Account: "*"
  Parameters:
    instanceArn: !Ref instanceArn
    principalId: !Ref adminGroup
    permissionSetName: "Administrator"
    managedPolicies: ["arn:aws:iam::aws:policy/AdministratorAccess"]
    sessionDuration: "PT1H"
    masterAccountId: "151027435675"
```

You can find the `masterAccountId` on the AWS Organizations page. It is the number located next to the email address of the management account.

After that, everything worked as expected. I now have two units for development and production, each with its own account. I can easily access both of these using the SSO portal. Nice!

  </StepsItem>
</Steps>

## Concluding thoughts

Now, I didn't really have to go through all this hassle to set up my AWS account. I could have just used my previous account and been more strict with IAM roles and permissions for each IAM user i create. Nevertheless, this experience and tinkering around with `org-formation` exposed me to two AWS services I had never heard of before - CodeCommit and CodePipeline. I even got my hands dirty editing CloudFormation templates, a service used in production by many companies.

One thing i would say though is that the whole account management strategy and infrastructure side of IAM and AWS is not really my jam, but I find it interesting nonetheless. It is clear that managing AWS accounts for entire engineering organisations can be complicated - it makes me appreciate the AWS credentials that I have at my place of employment.

Now that i have an account, the next step is to jump right into building. In the next part of the series, i will be building and deploying the front end of the cloud resume using AWS services.

Till next time.
